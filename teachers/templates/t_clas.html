{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<h1 class="mb-3">{% trans "List of Classes" %}</h1>

<!-- Filter Card -->
<div class="card mb-3">
  <div class="card-header d-flex align-items-center">
    <i class="fas fa-filter me-2"></i>
    <b>{% trans "Filter" %}</b>
  </div>
  <div class="card-body">
    <form method="get" class="row g-3">
      <!-- Academic Year -->
      <div class="col-md-4">
        <label for="academic_year" class="form-label">{% trans "Academic Year" %}</label>
        <select name="academic_year" id="academic_year" class="form-control">
          <option value="">{% trans "-- All --" %}</option>
          {% for year in academic_years|default:available_years %}
            <option value="{{ year }}"
              {% if selected_year == year or selected_academic_year == year %}selected{% endif %}>
              {{ year }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Semester -->
      <div class="col-md-4">
        <label for="semester" class="form-label">{% trans "Semester" %}</label>
        <select name="semester" id="semester" class="form-control">
          <option value="">{% trans "-- All --" %}</option>
          {% for sem in semesters|default:available_semesters %}
            <option value="{{ sem }}"
              {% if selected_semester_int == sem or selected_semester == sem|stringformat:"s" %}selected{% endif %}>
              {{ sem }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Actions -->
      <div class="col-md-4 d-flex align-items-end">
        <button type="submit" class="btn btn-primary me-2">
          <i class="fas fa-search me-1"></i>{% trans "Search" %}
        </button>
        <a href="{% url 't_clas' teacher1.id choice %}" class="btn btn-outline-secondary">
          <i class="fas fa-redo me-1"></i>{% trans "Reset" %}
        </a>
      </div>
    </form>
  </div>
</div>

<!-- List Card -->
<div class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      {% if selected_year or selected_academic_year or selected_semester or selected_semester_int %}
        {% trans "Filtered Classes" %}
        {% with y=selected_year|default:selected_academic_year s=selected_semester|default:selected_semester_int %}
          {% if y and s %} - {% trans "Year" %} {{ y }}, {% trans "Semester" %} {{ s }}
          {% elif y %} - {% trans "Year" %} {{ y }}
          {% elif s %} - {% trans "Semester" %} {{ s }}
          {% endif %}
        {% endwith %}
      {% else %}
        {% trans "All Classes" %}
      {% endif %}
    </h5>
    {% if selected_year or selected_academic_year or selected_semester or selected_semester_int %}
      <span class="badge bg-info">
        <i class="fas fa-filter"></i> {% trans "Filtered" %}
      </span>
    {% endif %}
  </div>

  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle text-center" id="dataTable" width="100%" cellspacing="0">
        <thead>
          <tr>
            <th>{% trans "Class" %}</th>
            <th>{% trans "Course" %}</th>
            <th>{% trans "Semester" %}</th>
            <th style="width: 280px;"></th>
          </tr>
        </thead>
        <tbody>
          {% for ass in assignments %}
            <tr>
              <td>
                {% if ass.class_id.dept %}{{ ass.class_id.dept.name }}{% else %}{{ ass.class_id }}{% endif %}
                : {{ ass.class_id.sem }} {{ ass.class_id.section }}
              </td>
              <td>
                {% if ass.subject %}{{ ass.subject.name }}{% else %}{{ ass.subject }}{% endif %}
              </td>
              <td>
                <span class="badge bg-primary">
                  <i class="fas fa-calendar me-1"></i>
                  {# Hiển thị year_sem nếu có; fallback academic_year.semester #}
                  {% if ass.year_sem %}
                    {{ ass.year_sem }}
                  {% else %}
                    {{ ass.academic_year }}.{{ ass.semester }}
                  {% endif %}
                </span>
              </td>
              <td class="text-nowrap">
                {% if choice == 1 %}
                  <a class="btn btn-primary btn-sm" href="{% url 't_class_date' ass.id %}">
                    <i class="fas fa-check me-1"></i>{% trans "Enter Attendance" %}
                  </a>

                {% elif choice == 2 %}
                  <a class="btn btn-primary btn-sm" href="{% url 't_marks_list' ass.id %}">
                    <i class="fas fa-pen me-1"></i>{% trans "Enter Marks" %}
                  </a>
                  <a class="btn btn-info btn-sm" href="{% url 'view_students' ass.id %}">
                    <i class="fas fa-users me-1"></i>{% trans "View Students" %}
                  </a>

                {% elif choice == 3 %}
                  <a class="btn btn-warning btn-sm" href="{% url 't_report' ass.id %}">
                    <i class="fas fa-chart-bar me-1"></i>{% trans "Generate Reports" %}
                  </a>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4" class="text-center text-muted py-4">
                <i class="fas fa-search fa-2x mb-3 d-block text-secondary"></i>
                {% if selected_year or selected_academic_year or selected_semester or selected_semester_int %}
                  <h6 class="mb-2">{% trans "No classes found with current filters" %}</h6>
                  {% with y=selected_year|default:selected_academic_year s=selected_semester|default:selected_semester_int %}
                    <p class="mb-3">
                      {% if y and s %}{% trans "No classes found for year" %} {{ y }}, {% trans "Semester" %} {{ s }}
                      {% elif y %}{% trans "No classes found containing year" %} {{ y }}
                      {% elif s %}{% trans "No classes found for semester" %} {{ s }}
                      {% endif %}
                    </p>
                  {% endwith %}
                  <a href="{% url 't_clas' teacher1.id choice %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-times me-1"></i>{% trans "Clear Filters" %}
                  </a>
                {% else %}
                  <h6 class="mb-1">{% trans "No classes assigned" %}</h6>
                  <p class="mb-0">{% trans "This teacher has no courses assigned." %}</p>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# Pagination #}
    {% if assignments.has_other_pages %}
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted small">
          {% trans "Showing" %} {{ assignments.start_index }} {% trans "to" %} {{ assignments.end_index }}
          {% trans "of" %} {{ assignments.paginator.count }} {% trans "entries" %}
        </div>
        <nav aria-label="Page navigation">
          <ul class="pagination pagination-sm mb-0">
            {% if assignments.has_previous %}
              <li class="page-item">
                <a class="page-link"
                   href="?{% if selected_year %}academic_year={{ selected_year }}&{% elif selected_academic_year %}academic_year={{ selected_academic_year }}&{% endif %}{% if selected_semester %}semester={{ selected_semester }}&{% elif selected_semester_int %}semester={{ selected_semester_int }}&{% endif %}page={{ assignments.previous_page_number }}">
                  {% trans "Previous" %}
                </a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">{% trans "Previous" %}</span></li>
            {% endif %}

            {% for num in assignments.paginator.page_range %}
              {% if num == assignments.number %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% elif num > assignments.number|add:'-3' and num < assignments.number|add:'3' %}
                <li class="page-item">
                  <a class="page-link"
                     href="?{% if selected_year %}academic_year={{ selected_year }}&{% elif selected_academic_year %}academic_year={{ selected_academic_year }}&{% endif %}{% if selected_semester %}semester={{ selected_semester }}&{% elif selected_semester_int %}semester={{ selected_semester_int }}&{% endif %}page={{ num }}">
                    {{ num }}
                  </a>
                </li>
              {% endif %}
            {% endfor %}

            {% if assignments.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="?{% if selected_year %}academic_year={{ selected_year }}&{% elif selected_academic_year %}academic_year={{ selected_academic_year }}&{% endif %}{% if selected_semester %}semester={{ selected_semester }}&{% elif selected_semester_int %}semester={{ selected_semester_int }}&{% endif %}page={{ assignments.next_page_number }}">
                  {% trans "Next" %}
                </a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">{% trans "Next" %}</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
